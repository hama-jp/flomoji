# 要件定義書: LLMノードへのシステムプロンプト設定機能

## 1. 機能概要
ワークフロー内の各「LLM生成(llm)」ノードに対して、個別の「システムプロンプト」を設定できる機能を追加する。

## 2. 目的と背景
現状、LLMノードはユーザーからの入力プロンプトのみを受け付ける仕様となっている。しかし、より高度なLLMの活用（例：特定の役割を演じさせる、出力形式を厳密に指定する、特定の思考プロセスを強制する等）には、ユーザープロンプトとは別に、LLMの基本的な振る舞いを定義する「システムプロンプト」が不可欠である。
本機能により、ユーザーはノードごとにLLMの役割や応答スタイルを細かく制御できるようになり、ワークフローの柔軟性と表現力が大幅に向上する。

## 3. 機能要件
### 3.1. UI/UX要件
- **R-UI-1: プロパティパネルの項目変更**
  - ユーザーが「LLM生成」ノードを選択した際、右側のプロパティ編集パネルの構成を変更する。
  - 既存の「プロンプト」テキストエリアを**削除**する。これにより、LLMへのユーザー入力は、ノードへの接続から供給されるデータのみとなる。
  - 新たに「システムプロンプト (System Prompt)」というラベルのテキストエリアを設置する。
  - プレースホルダーとして「LLMの役割や応答に関する指示を入力...」のような案内文を表示する。

### 3.2. データ永続化要件
- **R-DA-1: データ構造の変更**
  - 「LLM生成」ノードのデータオブジェクト(`node.data`)から、既存の`prompt`キーを**削除**する。
  - 新たに`systemPrompt`というキーを追加し、ユーザーが入力した文字列を保存する。
- **R-DA-2: ワークフロー保存・復元**
  - ワークフローが保存（自動保存含む）、エクスポートされる際に、各LLMノードの`systemPrompt`の内容も完全に保持されること。
  - インポートされたワークフローに`systemPrompt`が含まれている場合、正しく読み込まれ、UIに表示されること。

### 3.3. 実行ロジック要件
- **R-EX-1: システムプロンプトの送信**
  - LLMノードが実行される際、`systemPrompt`に入力があれば、その内容をLLM APIリクエストに含めて送信する。
  - `systemPrompt`が未入力または空文字列の場合は、システムプロンプトに関する情報をリクエストに含めない。
- **R-EX-2: プロバイダーごとの適切な形式**
  - **OpenAI互換API (OpenAI, Local, Custom):** `messages`配列の先頭に `{ "role": "system", "content": "..." }` という形式でシステムプロンプトを追加する。
  - **Anthropic API:** リクエストボディのトップレベルに `"system": "..."` というキーでシステムプロンプトを追加する。
- **R-EX-3: 他ノードへの非影響**
  - 本変更は「LLM生成」ノードのみに影響し、「If条件分岐」ノードなど、内部でLLMを使用する他のノードの動作には影響を与えないこと。

## 4. 非機能要件
- **R-NF-1: UIの一貫性**
  - 追加されるUIコンポーネントは、既存のUIコンポーネント（`Input`, `Textarea`, `Label`など）と視覚的な一貫性を保つこと。
- **R-NF-2: パフォーマンス**
  - システムプロンプトの追加による、ワークフローの実行速度への顕著な影響（例: 100ms以上の遅延）を避けること。

## 5. 範囲外
- ワークフロー全体で共有されるグローバルなシステムプロンプトの設定。
- 実行コンテキスト内の変数（例: 他のノードの出力）を動的にシステムプロンプト内で展開する機能。システムプロンプトは静的なテキストのみとする。
- 「If条件分岐」ノード内のLLM判断にシステムプロンプトを適用すること。

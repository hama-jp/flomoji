# 実装TODOリスト: cronトリガーノード機能

## 0. 共通の知識

このタスクは、スケジュールに基づいてワークフローを自動実行する「cronトリガーノード」を実装するものです。

**最重要**: この機能はクライアントサイドで完結するため、**アプリケーションのブラウザタブが開いている間のみ動作します**。この制約を念頭に置き、UIの適切な箇所でユーザーに明記する必要があります。

**関連ドキュメント:**
-   [要件定義書](./requirements_cron_triggered_workflows.md): 機能全体の目的、アーキテクチャ、詳細な仕様が記載されています。実装前に必ずお読みください。
-   [構想ドキュメント](../../idea/FS_05_cron_triggered_workflows.md): 元となったアイデアです。

---

## Step 0: スモークテスト
-   [ ] **既存テストの実行**:
    -   開発を開始する前に、既存のテストスイートを実行し、すべてがパスすることを確認する。これにより、クリーンな状態から作業を開始できる。
    -   コマンド: `pnpm test` (またはプロジェクトで定義されているテストコマンド)

---

## 1. 基盤構築 (Service & Library)
-   [ ] **パッケージインストール**:
    -   `pnpm add croner` を実行し、`croner` ライブラリをプロジェクトの依存関係に追加する。
-   [ ] **スケジューラサービスの新規作成**:
    -   `src/services/schedulerService.js` という新しいファイルを作成する。
    -   (オプション) `src/services/schedulerService.test.js` というテストファイルを作成する。
-   [ ] **スケジューラサービスの実装**:
    -   `schedulerService.js` 内で、アプリケーション全体のスケジュールを管理するシングルトンクラスまたはオブジェクトを定義する。
    -   以下の主要な非同期メソッドを実装する:
        -   `initializeSchedules(workflows)`
        -   `addOrUpdateSchedule(workflowId, cronExpression, options)`
        -   `removeSchedule(workflowId)`
        -   `triggerWorkflow(workflowId, payload)`
    -   `croner` インスタンスを内部で管理し、タイマーのセットと解除を行うロジックを実装する。
-   [ ] **検証**:
    -   `schedulerService` のユニットテストを作成し、スケジュールの追加、削除、およびタイマー発火のロジックが正しく動作することを確認する。
    -   `pnpm run lint` を実行し、新しいコードにlintエラーがないことを確認する。

---

## 2. 実行ロジックへの組込
-   [ ] **`NodeExecutionService.js` の改修**:
    -   `executeNode` メソッド内の `switch` 文に `case 'schedule':` を追加する。
    -   この `case` ブロック内では、ノードの設定（`node.data`）から「出力ペイロード」を読み取り、それをノードの実行結果として返す処理を実装する。動的変数 `{{timestamp}}` を現在の日時（ISO文字列など）に置換するロジックもここに追加する。
-   [ ] **検証**:
    -   `NodeExecutionService` に関連する既存のテストを更新、または新しいテストを追加し、`schedule` ノードが正しく処理されることを確認する。
    -   `pnpm run lint` を実行し、コードスタイルが規約に準拠していることを確認する。
    -   `pnpm test` を実行し、リグレッションが発生していないことを確認する。

---

## 3. UI実装
-   [ ] **スケジュールノードコンポーネントの新規作成**:
    -   `src/components/nodes/ScheduleNode.jsx` のようなパスに、スケジュールトリガーノード専用のReactコンポーネントを新規作成する。
-   [ ] **設定パネルの実装**:
    -   ノードが選択されたときに表示される設定パネルに、Cron式入力、タイムゾーン選択、出力ペイロード編集エリア、プリセット選択ボタンを実装する。
-   [ ] **ワークフロー単位でのスケジュール有効化UI**:
    -   `src/components/WorkflowView.jsx` を改修し、`schedule` ノードが存在する場合に「スケジュールを有効化」トグルスイッチを表示する。
    -   トグルの状態をワークフローデータに保存し、`schedulerService` と連携させる。
-   [ ] **検証**:
    -   (可能であれば) CypressやPlaywrightなどのE2Eテストツールで、UIの操作（ノードの追加、スケジュールの有効化/無効化）が正しく機能することを確認する。
    -   `pnpm run lint` を実行し、新しいコンポーネントにlintエラーがないことを確認する。

---

## 4. 全体連携とドキュメント
-   [ ] **アプリケーション起動時の処理**:
    -   アプリケーションのエントリーポイントで `schedulerService.initializeSchedules` を呼び出す処理を追加する。
-   [ ] **ユーザーへの制約の通知**:
    -   「スケジュールを有効化」トグルの横にツールチップを追加し、機能の制約を明記する。
-   [ ] **機能ドキュメントの更新**:
    -   必要に応じて、ヘルプやドキュメントを更新する。
-   [ ] **最終検証**:
    -   アプリケーションを実際に動かし、スケジュールを設定したワークフローが指定時刻に自動実行されることを手動で確認する（総合テスト）。
    -   `pnpm run lint` と `pnpm test` を再度実行し、すべてのチェックが通ることを確認する。

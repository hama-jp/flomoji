# 要件定義書: ワークフロー実行ログ機能の強化

## 1. 背景と目的

本アプリケーションは、ブラウザ上でLLMを活用したワークフローを構築・実行できる強力なツールである。しかし、現状ではワークフローの実行結果や、その過程でどのようなデータが処理されたかの詳細な履歴が保存されていない。

この問題を解決するため、以下の2つの機能を強化する。

1.  **ワークフロー実行ログ機能**: ワークフローがいつ、どのように実行され、各ステップ（ノード）でどのような結果になったかを永続的に記録する。これにより、ユーザーは過去の実行を振り返り、デバッグや結果の再現が容易になる。
2.  **LLM呼び出しモニタリング機能**: ワークフロー内で実行されるLLMへのAPIコールを可視化する。これにより、プロンプトの最適化、コスト管理、パフォーマンス分析が容易になる。

本ドキュメントは、これらの機能強化に関する要件を定義するものである。

## 2. スコープ

本ドキュメントは、機能の**設計**を定義するものであり、具体的な実装作業は含まない。

- **スコープ内**:
    - 機能要件の定義
    - データモデル（DBスキーマ）の設計
    - 利用技術の選定と連携方法の定義
- **スコープ外**:
    - 上記機能のプログラミング、テスト、デプロイ

## 3. 機能要件

### 3.1. 機能要件①: ワークフロー実行ログ

#### 3.1.1. 概要
ワークフローの実行ごとに一意の実行履歴を作成し、その中で実行された各ノードの入出力、ステータス、エラー情報などを時系列で記録・永続化する。

#### 3.1.2. 解決策
ユーザーのブラウザ内にデータを効率的に保存・検索するため、`LocalStorage` よりも高機能な `IndexedDB` を採用する。実装を簡略化するため、`IndexedDB` のラッパーライブラリである `Dexie.js` を利用する。

#### 3.1.3. データモデル
`Dexie.js` を用いて、以下の2つのテーブル（オブジェクトストア）を定義する。

**1. `workflow_runs` テーブル**

-   **説明**: ワークフローが実行されるたびに1レコード作成される、実行全体のエントリ。
-   **スキーマ**:
    -   `id` (String, Primary Key): `ulid` や `nanoid` などで生成した一意のID。
    -   `workflowId` (String, Index): `workflowManagerService` で管理されているワークフローのID。
    -   `startedAt` (Date, Index): 実行開始日時。
    -   `endedAt` (Date): 実行終了日時。
    -   `status` (String, Index): 'running', 'completed', 'error', 'stopped' のいずれか。
    -   `inputData` (Object): ワークフロー実行時の初期入力データ。

**2. `node_logs` テーブル**

-   **説明**: 1つのワークフロー実行内で、ノードが処理されるたびに記録される詳細ログ。
-   **スキーマ**:
    -   `id` (String, Primary Key): 一意のログID。
    -   `runId` (String, Index): `workflow_runs` テーブルの `id` への外部キー。
    -   `nodeId` (String, Index): ワークフロー定義内のノードID。
    -   `nodeType` (String): ノードの種類（'llm', 'if', 'text_combiner' など）。
    -   `nodeLabel` (String): ユーザーが設定したノードのラベル名。
    -   `timestamp` (Date): このログが記録された日時。
    -   `status` (String): 'running', 'completed', 'error' のいずれか。
    -   `inputs` (Object): ノードが受け取った入力データ。
    -   `outputs` (Object): ノードが生成した出力データ。
    -   `error` (Object): エラー発生時のエラー情報（`message`, `stack`など）。

#### 3.1.4. UI/UX
-   ワークフロー編集画面に「実行履歴」タブまたはボタンを新設する。
-   「実行履歴」には、`workflow_runs` テーブルの情報を基に、過去の実行がリスト表示される（実行日時、ステータスなど）。
-   リストから特定の実行を選択すると、`node_logs` テーブルの情報を基に、その実行における全ノードの処理結果がステップバイステップで表示される。

### 3.2. 機能要件②: LLM呼び出しのモニタリング

#### 3.2.1. 概要
LLMノードからAPIが呼び出される際の詳細（リクエスト、レスポンス、レイテンシ、トークン数など）を追跡・可視化するための仕組みを導入する。

#### 3.2.2. 解決策
LLMアプリケーションの可観測性（Observability）に特化したサードパーティツール `LangSmith` を利用する。`LangSmith` は、既存のコードへの変更を最小限に抑えつつ、詳細なトレースを提供できるため、本要件に適している。

#### 3.2.3. 連携方法
-   `llmService.js` の `sendMessage` 関数内で `fetch` を実行している箇所を、`LangSmith` のSDK（`@langchain/langsmith/wrappers`）でラップする。
-   これにより、`fetch` が行われるたびに、リクエストとレスポンスの情報が自動的に `LangSmith` のプロジェクトに送信される。
-   トレース情報には、`workflowId`、`runId`、`nodeId` などのメタデータを付与し、ワークフロー実行ログとの関連付けを可能にする。

#### 3.2.4. 設定
-   アプリケーションの「設定」画面に、「LangSmith APIキー」を入力するための新しいフィールドを追加する。
-   APIキーが設定されている場合のみ、`LangSmith` へのトレーシングを有効化する。APIキーは `localStorage` に保存する。

## 4. 非機能要件

-   **パフォーマンス**: ログ記録処理が、ワークフローの実行速度に顕著な悪影響を与えないこと。処理は非同期に行う。
-   **データ管理**: ユーザーが、ブラウザに保存された実行履歴（`IndexedDB` のデータ）を、設定画面などから任意に削除できる機能を提供すること。
-   **セキュリティ**: `LangSmith APIキー` などの機密情報は、`localStorage` に保存されるため、その旨をUI上でユーザーに明記すること。
